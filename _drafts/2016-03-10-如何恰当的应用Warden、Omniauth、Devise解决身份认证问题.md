---
layout: post
title: "如何恰当的应用Warden、Omniauth、Devise解决身份验证问题"
tags: []
---

身份验证是绝大多数项目都需要解决的问题。在ROR中处理身份验证时大家经常会选择的3个Gem包: Devise、Warden、Omniauth。本文的目的是通过对这3个Gem包的分析来探讨如何恰当的在项目中应用。

身份验证
---
    身份验证我们经常会遇到，那什么是身份验证？为什么要身份验证？如何进行身份验证？

    身份验证（英语：Authentication）又称“验证”、“鉴权”，是指通过一定的手段，完成对用户身份的确认。
    当需要确认当前所声称为某种身份的用户，确实是所声称的用户（证明你就是你）时，我们需要进行身份验证。
    现实当中我们进行身份验证的手段很多，五花八门，但基本思路是寻找能证明真实身份的因素。归总起来可以分为3类：
    * 知识因素（用户知道的），例如密码、问题答案等；
    * 所有权因素（用户拥有的），例如邮箱、手机号、令牌等；
    * 固有因素（用户固有的），例如指纹、虹膜、人脸等。

    根据安全等级的要求不同可以采用双因素、甚至多因素的身份验证。


Warden
---
    Warden是通用的Rack身份验证框架。它本身是一个Rack中间件，为基于Rack的Ruby Web应用提供了一种身份验证机制。
    随着Rack越来越被大家认可和接受，可以实现同一进程内运行多个子应用，甚至子子应用。多应用很吸引人，但在这种情况下也存在一个问题，即如何管理身份验证。
    Warden允许所有下游的中间件和端点共享相同的验证机制，同时保持对应用的全面管理。每个应用可以访问已验证的用户或以相同的方法请求验证。
    在Warden中，每种不同的身份验证方式作为一种验证策略，具体的身份验证过程在身份验证策略中完成。Warden还支持Scope以允许多用户同时登录。

Omniauth
---
    Omniauth是一个身份验证框架，目的是为Web应用的多身份验证提供商进行标准化（例如同时允许用微信、微博等多种第三方帐号登录）。针对各种不同的身份验证提供商进行开发是困难的，Omniauth对身份验证进行了抽象，采用统一的方法，使得开发变得简单。
    Omniauth认为每个身份验证系统本质上可归结为两个阶段：请求阶段(request phase)和回调阶段(callback phase)。
    在请求阶段，我们从用户处请求完成身份验证所需要的信息。这些信息被POST到一个URL或在外部执行身份验证过程，例如OpenID。
    在回调阶段，我们收到经过身份验证的唯一标识符，它可以区分在同一验证系统中用户和其他用户。此外，还提供更详细的验证用户信息。
    在Omniauth中，不同身份验证提供商通过不同的身份验证策略完成。

Devise
---
    Devise是针对Rails项目的弹性身份验证解决方案，它依赖于Warden。它有3个特点：
    * 基于Rack
    * 基于Rails引擎的完整MVC解决方案
    * 在同一时间允许多Model登录
    * 基于流行的概念：只在真实需要的时候用它

    Devise提供的10个模块：
    * Database Authenticatable
    * Omniauthable
    * Confirmable
    * Recoverable
    * Registerable
    * Rememberable
    * Trackable
    * Timeoutable
    * Validatable
    * Lockable

    Devise为什么会提供这10个模块？Devise的目的是提供身份验证解决方案，在一个身份系统中，首先要有基本的身份验证方式，例如基于邮箱和密码的身份验证，Database Authenticatable提供了这方面的支持。而现在第三方身份验证也是必须的，Omniauthable提供了第三方身份验证的模块。除了身份验证方式之外，作为身份验证解决方案还需要考虑其他一些问题，例如用户注册的问题、注册时是否是有效的邮箱问题、密码忘记后是否允许自助的找回密码、在首次登录时允许用户选择记住我（自动登录）、多次登录失败时是否锁定帐号等。Devise的其它模块为这方面的问题提供了支持。

总结
---
    Warden解决的是多应用共享身份验证的问题，Omniauth解决的是多身份验证提供商标准化问题，针对联盟验证（第三方身份验证）我们可以使用Omniauth，应用自身的身份验证采用Warden，对于既有自身身份验证系统，又支持第三方身份验证的应用可以两者结合使用，根据Omniauth的验证结果找回或登记用户，并将用户通过Warden的set_user接口供整个应用使用。
    针对Rails应用，我们可以使用Devise来构建应用的身份验证系统。




